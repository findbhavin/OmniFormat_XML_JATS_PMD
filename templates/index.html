<!DOCTYPE html>
<html>
<head>
    <title>OmniJAX - JATS 1.3 High-Fidelity Converter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 520px; text-align: center; }
        h1 { color: #1a73e8; margin-bottom: 0.25rem; }
        p.lead { margin-top: 0; color: #333; }
        .upload-box { border: 2px dashed #dadce0; padding: 1.25rem; border-radius: 8px; margin: 1.25rem 0; background: #fafafa; }
        input[type="file"] { width: 100%; }
        button { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; }
        button[disabled] { opacity: 0.6; cursor: not-allowed; }
        .info { font-size: 0.8rem; color: #5f6368; margin-top: 1rem; text-align: left; line-height: 1.4; }

        /* Progress UI */
        .progress-wrapper { display: none; margin-top: 1rem; text-align: left; }
        .progress-bar { width: 100%; background: #e9eef8; border-radius: 8px; overflow: hidden; height: 18px; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #1a73e8, #2a63d8); transition: width 300ms ease; }
        .status-text { margin-top: 0.5rem; font-size: 0.9rem; color: #333; }
        .download-link { display: inline-block; margin-top: 1rem; padding: 8px 12px; background: #0f9d58; color: #fff; border-radius: 6px; text-decoration: none; }
        .error-text { color: #d93025; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>OmniJAX</h1>
        <p class="lead">Professional JATS XML & Dual PDF Engine</p>

        <div class="upload-box">
            <input id="fileInput" type="file" name="file" accept=".docx" required>
        </div>

        <div>
            <button id="uploadBtn">Convert & Download Package</button>
        </div>

        <div class="progress-wrapper" id="progressWrapper">
            <div class="progress-bar" aria-hidden="true">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">Waiting...</div>
            <div class="error-text" id="errorText" style="display:none;"></div>
        </div>

        <div id="downloadArea"></div>

        <div class="info">
            • JATS 1.3 OASIS Compliant<br>
            • Automatic Table Caption Alignment (Top)<br>
            • Direct DOCX to PDF Included<br>
            • Media Folder Image Extraction
        </div>
    </div>

    <script>
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const errorText = document.getElementById('errorText');
        const downloadArea = document.getElementById('downloadArea');

        let pollInterval = null;

        uploadBtn.addEventListener('click', async () => {
            errorText.style.display = 'none';
            downloadArea.innerHTML = '';
            if (!fileInput.files || fileInput.files.length === 0) {
                errorText.textContent = 'Please choose a .docx file to convert.';
                errorText.style.display = 'block';
                return;
            }
            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.docx')) {
                errorText.textContent = 'Only .docx files are supported.';
                errorText.style.display = 'block';
                return;
            }

            uploadBtn.disabled = true;
            statusText.textContent = 'Uploading...';
            progressWrapper.style.display = 'block';
            progressFill.style.width = '5%';

            try {
                const formData = new FormData();
                formData.append('file', file);

                // Use fetch to send file to /convert (server should return conversion_id immediately)
                const resp = await fetch('/convert', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(`Upload failed: ${resp.status} ${txt}`);
                }

                const body = await resp.json();
                if (!body.conversion_id) {
                    throw new Error('Server did not return a conversion_id');
                }

                const conversionId = body.conversion_id;
                statusText.textContent = 'Queued — starting conversion...';
                progressFill.style.width = '10%';

                // Poll the status endpoint every 1s
                pollInterval = setInterval(async () => {
                    try {
                        const s = await fetch(`/status/${encodeURIComponent(conversionId)}`, { method: 'GET', headers: {'Accept':'application/json'} });
                        if (!s.ok) {
                            throw new Error('Failed to fetch status');
                        }
                        const status = await s.json();
                        // status object: { percent: <number>, stage: <string>, message: <string>, download_url: <string|null>, state: 'running'|'completed'|'failed' }
                        const pct = Math.max(0, Math.min(100, status.percent || 0));
                        progressFill.style.width = pct + '%';
                        statusText.textContent = status.stage ? `${status.stage} — ${status.message||''}` : (status.message || '');

                        if (status.state === 'completed' && status.download_url) {
                            clearInterval(pollInterval);
                            progressFill.style.width = '100%';
                            statusText.textContent = 'Conversion complete';
                            // show download link
                            const a = document.createElement('a');
                            a.href = status.download_url;
                            a.textContent = 'Download ZIP';
                            a.className = 'download-link';
                            a.setAttribute('download', '');
                            downloadArea.innerHTML = '';
                            downloadArea.appendChild(a);
                            uploadBtn.disabled = false;
                        } else if (status.state === 'failed') {
                            clearInterval(pollInterval);
                            progressFill.style.width = '0%';
                            statusText.textContent = 'Conversion failed';
                            errorText.textContent = status.message || 'Conversion failed. See server logs.';
                            errorText.style.display = 'block';
                            uploadBtn.disabled = false;
                        }
                    } catch (err) {
                        clearInterval(pollInterval);
                        errorText.textContent = 'Status polling failed: ' + err;
                        errorText.style.display = 'block';
                        uploadBtn.disabled = false;
                    }
                }, 1000);

            } catch (err) {
                uploadBtn.disabled = false;
                errorText.textContent = err.toString();
                errorText.style.display = 'block';
                progressWrapper.style.display = 'block';
                statusText.textContent = 'Error';
            }
        });
    </script>
</body>
</html>